---
name: CodeQL Analysis

on:
  workflow_call:
    inputs:
      languages_json:
        type: string
        required: false
        description: 'JSON array. Ej: ["javascript","java"]'
      language:
        type: string
        required: false
        description: 'Single language. Ej: "javascript"'
      mode:
        type: string
        default: "warning"
      run_build:
        type: boolean
        default: false
      build_command:
        type: string
        required: false

jobs:
  # ========== MULTI-LANGUAGE (matrix) ==========
  analyze-matrix:
    # Evita fromJSON sobre valores vacíos o no JSON
    if: ${{ inputs.languages_json != '' && startsWith(inputs.languages_json, '[') }}
    name: Analyze (matrix)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        lang: ${{ fromJSON(inputs.languages_json) }}

    steps:
      - uses: actions/checkout@v4

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.lang }}

      - name: Build (manual)
        if: ${{ inputs.run_build && inputs.build_command != '' }}
        run: ${{ inputs.build_command }}

      - name: Autobuild
        if: ${{ !inputs.run_build }}
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.lang }}"

      - name: Summary
        if: always()
        shell: bash
        run: |
          set +e
          SARIF="$(git ls-files -z | xargs -0 -I{} bash -lc '[[ "{}" == *.sarif ]] && echo "{}"' | head -n1 || true)"
          [[ -z "$SARIF" ]] && SARIF="$(find . -type f -name '*.sarif' | head -n1 || true)"
          if [[ -n "$SARIF" ]] && command -v jq >/dev/null 2>&1; then
            TOTAL=$(jq '[.runs[].results] | map(length) | add // 0' "$SARIF")
            ERR=$(jq '[.runs[].results[]? | select(.level=="error")]   | length' "$SARIF")
            WARN=$(jq '[.runs[].results[]? | select(.level=="warning")] | length' "$SARIF")
            NOTE=$(jq '[.runs[].results[]? | select(.level=="note")]    | length' "$SARIF")
          else
            TOTAL=0; ERR=0; WARN=0; NOTE=0
          fi
          BADGE="![status](https://img.shields.io/badge/CodeQL-${TOTAL}%20alerts-$([[ $TOTAL -eq 0 ]] && echo brightgreen || echo orange))"
          {
            echo "## CodeQL (${{ matrix.lang }})"
            echo
            echo "$BADGE"
            echo
            echo "| Severidad | Conteo |"
            echo "|---|---:|"
            echo "| Error    | $ERR |"
            echo "| Warning  | $WARN |"
            echo "| Note     | $NOTE |"
            echo "| **Total**| **$TOTAL** |"
            echo
            [[ -n "$SARIF" ]] && echo "_Archivo analizado:_ \`$SARIF\`" && echo
            echo "> Revisa **Security → Code scanning alerts** para el detalle."
          } >> "$GITHUB_STEP_SUMMARY" || true

    continue-on-error: ${{ inputs.mode == 'warning' }}

  # ========== SINGLE-LANGUAGE ==========
  analyze-single:
    if: ${{ (inputs.languages_json == '' || !startsWith(inputs.languages_json, '[')) && inputs.language != '' }}
    name: Analyze (${{ inputs.language }})
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: CodeQL Init
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ inputs.language }}

      - name: Build (manual)
        if: ${{ inputs.run_build && inputs.build_command != '' }}
        run: ${{ inputs.build_command }}

      - name: Autobuild
        if: ${{ !inputs.run_build }}
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ inputs.language }}"

      - name: Summary
        if: always()
        shell: bash
        run: |
          set +e
          SARIF="$(git ls-files -z | xargs -0 -I{} bash -lc '[[ "{}" == *.sarif ]] && echo "{}"' | head -n1 || true)"
          [[ -z "$SARIF" ]] && SARIF="$(find . -type f -name '*.sarif' | head -n1 || true)"
          if [[ -n "$SARIF" ]] && command -v jq >/dev/null 2>&1; then
            TOTAL=$(jq '[.runs[].results] | map(length) | add // 0' "$SARIF")
            ERR=$(jq '[.runs[].results[]? | select(.level=="error")]   | length' "$SARIF")
            WARN=$(jq '[.runs[].results[]? | select(.level=="warning")] | length' "$SARIF")
            NOTE=$(jq '[.runs[].results[]? | select(.level=="note")]    | length' "$SARIF")
          else
            TOTAL=0; ERR=0; WARN=0; NOTE=0
          fi
          BADGE="![status](https://img.shields.io/badge/CodeQL-${TOTAL}%20alerts-$([[ $TOTAL -eq 0 ]] && echo brightgreen || echo orange))"
          {
            echo "## CodeQL (${{ inputs.language }})"
            echo
            echo "$BADGE"
            echo
            echo "| Severidad | Conteo |"
            echo "|---|---:|"
            echo "| Error    | $ERR |"
            echo "| Warning  | $WARN |"
            echo "| Note     | $NOTE |"
            echo "| **Total**| **$TOTAL** |"
            echo
            [[ -n "$SARIF" ]] && echo "_Archivo analizado:_ \`$SARIF\`" && echo
            echo "> Revisa **Security → Code scanning alerts** para el detalle."
          } >> "$GITHUB_STEP_SUMMARY" || true

    continue-on-error: ${{ inputs.mode == 'warning' }}

  # ========== GUARD: sin inputs válidos ==========
  no-valid-inputs:
    if: ${{ (inputs.languages_json == '' || !startsWith(inputs.languages_json, '[')) && inputs.language == '' }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "::error::Debes pasar 'languages_json' (JSON válido, p.ej. '[\"javascript\",\"java\"]') o 'language' (p.ej. 'javascript')."
          exit 1
