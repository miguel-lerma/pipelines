---
name: Build & Test (Node + React)

on:
  workflow_call:
    inputs:
      app_dir:
        required: true
        type: string

permissions:
  contents: read

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.app_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect lockfile
        id: lock
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="${{ inputs.app_dir }}"
          if [ -f "$APP_DIR/package-lock.json" ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
            echo "lock_path=$APP_DIR/package-lock.json" >> "$GITHUB_OUTPUT"
          elif [ -f "$APP_DIR/pnpm-lock.yaml" ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
            echo "lock_path=$APP_DIR/pnpm-lock.yaml" >> "$GITHUB_OUTPUT"
          elif [ -f "$APP_DIR/yarn.lock" ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
            echo "has_lock=true" >> "$GITHUB_OUTPUT"
            echo "lock_path=$APP_DIR/yarn.lock" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
            echo "has_lock=false" >> "$GITHUB_OUTPUT"
            echo "lock_path=" >> "$GITHUB_OUTPUT"
          fi

      # Con cache solo si hay lockfile
      - name: Setup Node (con cache)
        if: steps.lock.outputs.has_lock == 'true' && steps.lock.outputs.manager == 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: ${{ steps.lock.outputs.lock_path }}

      - name: Setup Node (sin cache)
        if: steps.lock.outputs.has_lock != 'true' || steps.lock.outputs.manager != 'npm'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar deps
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Lint
        run: npm run lint --if-present

      - name: Test
        run: npm test --if-present -- --ci --watch=false

      - name: Build
        run: npm run build --if-present

      - name: Upload reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-reports
          path: |
            **/jest-junit*.xml
            **/test-results/**/*.xml
          if-no-files-found: ignore
