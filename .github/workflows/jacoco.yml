name: JaCoCo (informativo)
on:
  workflow_call:
    inputs:
      app_dir:
        required: true
        type: string
      coverage_min:
        type: string
        default: '0'

permissions:
  contents: read

jobs:
  jacoco:
    name: JaCoCo (informativo)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.app_dir }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - run: mvn -q -DskipTests=false test jacoco:report
      - id: cov
        run: |
          FILE=target/site/jacoco/jacoco.xml
          if [ -f "$FILE" ]; then
            MISSED=$(grep -oP 'counter type="LINE" missed="\\K[0-9]+' "$FILE" | head -1 || echo 0)
            COVERED=$(grep -oP 'counter type="LINE".*covered="\\K[0-9]+' "$FILE" | head -1 || echo 0)
            TOTAL=$((MISSED + COVERED))
            PCT=0
            if [ "$TOTAL" -gt 0 ]; then PCT=$((100 * COVERED / TOTAL)); fi
            echo "pct=$PCT" >> "$GITHUB_OUTPUT"
          else
            echo "pct=0" >> "$GITHUB_OUTPUT"
          fi
      - run: |
          echo "### JaCoCo Coverage" >> $GITHUB_STEP_SUMMARY
          echo "**Line Coverage:** ${{ steps.cov.outputs.pct }}%" >> $GITHUB_STEP_SUMMARY
          echo "_(informativo; umbral m√≠nimo: ${{ inputs.coverage_min }}%)_"
    continue-on-error: true